<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" type="text/css" id="css" href="style.css"/>
    </head>
    
	<body >
	
	
 <script src="script/jquery.js" type="text/javascript"></script>
 <script src="script/background.js"></script>
 <script src="script/include.js"></script>
 
 <script src="lib/quintus.js"></script>
 <script src="lib/quintus_2d.js"></script>
 <script src="lib/quintus_2d2.js"></script>
 <script src="lib/quintus_anim.js"></script>
 <script src="lib/quintus_audio.js"></script>
 <script src="lib/quintus_input.js"></script>
 <script src="lib/quintus_scenes.js"></script>
 <script src="lib/quintus_sprites.js"></script>
 <script src="lib/quintus_touch.js"></script>
 <script src="lib/quintus_ui.js"></script>


	<div id='loading'>
		<div id='loading_container'>
        	Loading...
        	<div id='loading_progress'>
            </div>
      	</div>
    </div>



<script>		

	var wi = document.documentElement.clientWidth * 0.9;
	if (wi>960){wi=960;}
	var hi = document.documentElement.clientHeight -40 ;
	if (hi>610){hi=610;}
	
	// Initialisation du moteur de jeu <img src="html.jpg">
        var Q = Quintus()
            .include("Audio, Sprites, Scenes, Input, 2D, 2D2, Touch, UI")
			.setup({
                width: wi,
                height: hi,
                development: true,
				upsampleWidth:  420,  // Double the pixel density of the 
  				upsampleHeight: 320,  // game if the w or h is 420x320
				downsampleWidth: 1024, // Halve the pixel density if resolution
  				downsampleHeight: 768 
				//maximize: "touch"
				//maximize : true
			})
			.controls()
			//.enableSound()
			.touch();
	
	   
    //Création du personnage principal / ennemis
		include ('personnage.js');
        include ('ennemis.js');


 	//Comportement for common enemy behaviors
    	Q.component("commonEnemy", {
            added: function() {
                var entity = this.entity;
                entity.on("bump.left,bump.right,bump.bottom",function(collision) {
                    if(collision.obj.isA("Orange")) {                        
                    	collision.obj.damage();
                    }
                });
				
                entity.on("bump.top",function(collision) {
                    if(collision.obj.isA("Orange")) { 
                        //make the player jump
                        collision.obj.p.vy = -100;
                        this.destroy();
                    }
                });
            },
            
        });


	// Comportement des cubes du sol  -> POSSIBLE ENLEVER SI BLOC UNIQUEMENT PREMIER
		 Q.component("cube", {
            added: function() {
                var entity = this.entity;				
                entity.on("bump.top",function(collision) {
                	if(collision.obj.isA("Orange")) { 
                    	if (collision.obj.first == 1){
							collision.obj.first = 0 ;
							collision.obj.sol = this;
							this.variable--;
						}else{
							if (this != collision.obj.sol){             
								this.variable--;
								if (collision.obj.sol != null){
							 		if (collision.obj.sol.variable == 0){
										collision.obj.sol.destroy();
									}
								}
								collision.obj.sol = this;
								if (this.variable == 0){
									this.destroy();
								}
							}
						}
					}    
                });
            },
        });
		
		
	// Cube qui s'autodetruise apres nb passage du personnage
		 Q.component("AutoCube", {
            added: function() {
                var entity = this.entity;				
                entity.on("bump.top",function(collision) {
                    if(collision.obj.isA("Orange")) { 
					if (this != collision.obj.sol){             
                      	this.variable = this.variable - 1;						 
						if (collision.obj.sol.variable == 0){
							collision.obj.sol.destroy();}
						collision.obj.sol = this;
					}}
                });
            },
        });
			     
		
	//Differents sprites de cubes...	
	// variable = nb fois que l'on peut marcher sur le cube

				   
		Q.Sprite.extend("Sol_1", {
            init: function(p) {
                this._super(p,  {gravity : 0, asset : "neige.png"});
				this.variable = 1;
				this.add("2d2, cube");
            }
        });
		
		Q.Sprite.extend("Sol_2", {
            init: function(p) {
                this._super(p,  {gravity : 0, asset : "neige.png"});
				this.variable = 2;
				this.add("2d2, cube");
            }
        });
		
		 Q.Sprite.extend("Sol_3", {
            init: function(p) {
                this._super(p,  {gravity : 0, asset : "fond_pierre_haut2.png"});
				this.variable = 3;
				this.add("2d2, cube");
            }
        });		   
		
		Q.Sprite.extend("Sol_5", {
            init: function(p) {
                this._super(p,  {gravity : 0, asset : "fond_pierre_haut2.png"});
				this.variable = 5;
				this.add("2d2, cube");
            }
        });
		
		
		Q.Sprite.extend("Sol_pierre1_D", {
            init: function(p) {
                this._super(p,  {gravity : 0, asset : "fond_pierre_haut.png"});
				this.variable = 1;
				this.add("2d2, AutoCube");
            }
        });
		
		Q.Sprite.extend("Sol_pierre2_D", {
            init: function(p) {
                this._super(p,  {gravity : 0, asset : "fond_pierre_haut.png"});
				this.variable = 2;
				this.add("2d2, AutoCube");
            }
        });
		
		Q.Sprite.extend("Sol_pierre3_D", {
            init: function(p) {
                this._super(p,  {gravity : 0, asset : "fond_pierre_haut.png"});
				this.variable = 3;
				this.add("2d2, AutoCube");
            }
        });

		
	   			
	// Ajout des scenes lvl
		include ('lvl1.js');

		
	// Fenetre menu 
		Q.scene("Debut", function(stage) {
			
		var background = new Q.TileLayer({ dataAsset: "men.tmx", layerIndex: 0, sheet: "tilesmenu", tileW: 70, tileH: 70, type: Q.SPRITE_NONE });
        stage.insert(background);
			
		var Menu = stage.insert(new Q.UI.Container({
		    fill: "grey",
                x: wi/2,
                y: hi/2,
                border: 1,
                shadow: 3,
                shadowColor: "rgba(0,0,0,0.5)",
                w: wi/2,
                h: hi/2.5		
		    })
            );
		
		var men = stage.insert(new Q.UI.Button({ 
                    label: "¡ Jouer !",
                    color: "white",
                    x: 0,
                    y: 0
                }),Menu);
				
//Récuperer lvl en cour pour le relancer TODO				
				men.on("click",function() {
				Q.clearStages();
      			Q.stageScene('level1');
				Q.stageScene("gameStats",1);
				
     		 });
		});
		

	// Fenêtre de fin
        Q.scene("endGame",function(stage) {
					
		var background = new Q.TileLayer({ dataAsset: "men.tmx", layerIndex: 0, sheet: "tilesmenu", tileW: 70, tileH: 70, type: Q.SPRITE_NONE });
        stage.insert(background);
		
  			var GameoV = stage.insert(new Q.UI.Container({
                fill: "grey",
                x: wi/2,
                y: hi/2,
                border: 1,
                shadow: 3,
                shadowColor: "rgba(0,0,0,0.5)",
                w: 300,
                h: 200
                })
            );
			
			var msg = stage.insert(new Q.UI.Text({ 
                    label: "¡ Game Over !",
                    color: "white",
                    x: 0,
                    y: -30
                }),GameoV);
        
			var msg = stage.insert(new Q.UI.Button({ 
                    label: "Try again",
                    color: "white",
                    x: 0,
                    y: 30,
					fill: "#CCCCCC"
                }),GameoV);
		
		
//Récuperer lvl en cour pour le relancer TODO
			msg.on("click",function() {
        		Q.clearStages();
      			Q.stageScene('level1');
				Q.stageScene("gameStats",1);
     		 });
		});
		
		
       // Fenêtre des scores / vies
        Q.scene("gameStats", function(stage) {
            var statsContainer = stage.insert(new Q.UI.Container({
                fill: "grey",
                x: wi/2,
                y: hi-20,
                border: 1,
                shadow: 3,
                shadowColor: "rgba(0,0,0,0.5)",
                w: wi,
                h: 40
                })
            );

 			var lives = stage.insert(new Q.UI.Text({ 
                    label: "Lives x 2",
                    color: "white",
                    x: -wi/3,
                    y: 0
                }),statsContainer);
				
			 var temps = stage.insert(new Q.UI.Text({ 
                    label: "Temps : 00:00",
                    color: "white",
                    x: wi/3.5,
                    y: 0,
                }),statsContainer);				

 			
        });


        Q.load(["tiles_map.png", "player.png", "orange.png",  "banane.png", "ananas.png", "slime2.png", 
		"fly.png", "Lvl1.tmx", "fond_pierre.png","fond_pierre_haut.png","fond_pierre_haut2.png", "men.tmx",
		"htmltiles.jpg", "neige.png"
		]
		, function() {
 			
            Q.sheet("tiles","tiles_map.png", { tilew: 70, tileh: 70});  
			Q.sheet("tilesmenu","htmltiles.jpg", { tilew: 70, tileh: 70});   			
        	
			Q.stageScene("Debut");
			
			}, { 
			progressCallback: function(loaded,total) {
   			var element = document.getElementById("loading_progress");
    		element.style.width = Math.floor(loaded/total*100) + "%";
  			}		
			 
        });
 
</script>


<!-- phpmyvisites 
		<div id = "cache">

		<a href="http://st.free.fr/" title="phpMyVisites | Open source web analytics" 
		onclick="window.open(this.href);return(false);"><script type="text/javascript">

		var a_vars = Array();
		var pagename='';
		var phpmyvisitesSite = 264239;
		var phpmyvisitesURL = "http://st.free.fr/phpmyvisites.php";
	</script>
	<script language="javascript" src="http://st.free.fr/phpmyvisites.js" type="text/javascript"></script>
		<object><noscript><p>phpMyVisites | Open source web analytics</p></noscript>
        </object></a>
    
<!-- /phpmyvisites --> 

		</div>
    
    
    </body>
</html>
